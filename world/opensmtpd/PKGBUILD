# Maintainer: Lukas Fleischer <lfleischer@archlinux.org>
# Maintainer: Bruno Pagani <archange@archlinux.org>
# Contributor: T.J. Townsend <blakkheim@archlinux.org>
# Contributor: SÃ©bastien Luttringer
# Contributor: parchd <parchd@archlinux.info>

pkgname=opensmtpd
pkgver=7.4.0p0
pkgrel=3
pkgdesc="Free implementation of the server-side SMTP protocol"
arch=(x86_64)
url="https://www.opensmtpd.org/"
license=(custom)
depends=(libevent openssl pam libxcrypt esysusers zlib)
optdepends=('opensmtpd-filter-rspamd: rspamd integration')
makedepends=(signify)
provides=(smtp-server smtp-forwarder)
conflicts=(smtp-server smtp-forwarder)
backup=(etc/smtpd/smtpd.conf etc/smtpd/aliases)
options=(emptydirs)
source=("https://www.opensmtpd.org/archives/${pkgname}-${pkgver}.tar.gz"
        https://github.com/OpenSMTPD/OpenSMTPD/commit/24258ecc02.patch
        ${pkgname}-${pkgver}.signify::"${url}/archives/${pkgname}-${pkgver}.sum.sig"
        opensmtpd-20181026.pub
        opensmtpd.sysusers)
sha256sums=('c181ccc3434a11e583619e00028520d457fe062e34dc03beea358078220ce374'
            '5806c5c3751fdeb1e790af68060142b5cc40383f433d50eb1f2c8eb8f1d00d42'
            'bbdccb72eac8c713c1d24d6d48f3cfd8eb8ff7bf0f36e8b72bf389405c11dab7'
            'b74dca53567cd5070905a0a1acd77041805b6c0c4a0e1285830ea13654e1dcd5'
            '29ef725c187462f279eebe86ed91343e8fc9b4db8d15c74ab7b4e1ae1c3130f3')
install=${pkgname}.install

prepare() {
  signify -Cp ${pkgname}-20181026.pub \
           -x ${pkgname}-${pkgver}.signify \
              ${pkgname}-${pkgver}.tar.gz

  cd ${pkgname}-${pkgver}
  sed -ri 's,/etc/mail,/etc/smtpd,g' usr.sbin/smtpd/smtpd.conf
  patch -Np1 -i ../24258ecc02.patch
  autoreconf -vfi
}

build() {
  cd ${pkgname}-${pkgver}

  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc/smtpd \
    --sbindir=/usr/bin \
    --libexecdir=/usr/lib/smtpd \
    --without-libbsd \
    --with-path-mbox=/var/spool/mail \
    --with-path-empty=/var/empty \
    --with-path-socket=/run \
    --with-path-CAfile=/etc/ssl/certs/ca-certificates.crt \
    --with-user-smtpd=smtpd \
    --with-user-queue=smtpq \
    --with-group-queue=smtpq \
    --with-auth-pam

  make
}

package() {
  cd ${pkgname}-${pkgver}

  make DESTDIR="${pkgdir}" install SMTPD_QUEUE_USER=92

  ln -s /usr/bin/smtpctl "${pkgdir}"/usr/bin/sendmail
  ln -s /usr/bin/smtpctl "${pkgdir}"/usr/bin/mailq
  ln -s /usr/bin/smtpctl "${pkgdir}"/usr/bin/newaliases
  ln -s /usr/bin/smtpctl "${pkgdir}"/usr/bin/makemap

  install -Dm644 etc/aliases -t "${pkgdir}"/etc/smtpd/

  install -Dm644 LICENSE -t "${pkgdir}"/usr/share/licenses/${pkgname}/

  install -Dm644 ../opensmtpd.sysusers "${pkgdir}"/usr/lib/sysusers.d/opensmtpd.conf
}
