From 21c9afce4377a50864530d689cc1892bc751799e Mon Sep 17 00:00:00 2001
From: artoo <artoo@artixlinux.org>
Date: Sat, 8 Jul 2023 00:05:03 +0200
Subject: [PATCH] dmsquash-live: add union join overlay opt

---
 .../90dmsquash-live/dmsquash-live-root.sh     | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/modules.d/90dmsquash-live/dmsquash-live-root.sh b/modules.d/90dmsquash-live/dmsquash-live-root.sh
index 81c6ed8e..b79d6166 100755
--- a/modules.d/90dmsquash-live/dmsquash-live-root.sh
+++ b/modules.d/90dmsquash-live/dmsquash-live-root.sh
@@ -33,6 +33,7 @@ overlay_size=$(getarg rd.live.overlay.size=)
 
 getargbool 0 rd.live.overlay.thin && thin_snapshot="yes"
 getargbool 0 rd.live.overlay.overlayfs && overlayfs="yes"
+join=$(getarg rd.live.join -d join)
 
 # Take a path to a disk label and return the parent disk if it is a partition
 # Otherwise returns the original path
@@ -313,6 +314,9 @@ do_live_overlay() {
 if [ -e /run/initramfs/live/${live_dir}/${squash_image} ]; then
     SQUASHED="/run/initramfs/live/${live_dir}/${squash_image}"
 fi
+if [ -e /run/initramfs/live/${live_dir}/${join} ]; then
+    SQUASHED_JOIN="/run/initramfs/live/${live_dir}/${join}"
+fi
 if [ -e "$SQUASHED" ]; then
     if [ -n "$live_ram" ]; then
         imgsize=$(($(stat -c %s -- $SQUASHED) / (1024 * 1024)))
@@ -329,6 +333,13 @@ if [ -e "$SQUASHED" ]; then
     mkdir -m 0755 -p /run/initramfs/squashfs
     mount -n -t squashfs -o ro "$SQUASHED_LOOPDEV" /run/initramfs/squashfs
 
+    if [ -n "${join}" ]; then
+        SQUASHED_JOIN_LOOPDEV=$(losetup -f)
+        losetup -r "$SQUASHED_JOIN_LOOPDEV" $SQUASHED_JOIN
+        mkdir -m 0755 -p /run/initramfs/joinfs
+        mount -n -t squashfs -o ro "$SQUASHED_LOOPDEV" /run/initramfs/joinfs
+    fi
+
     if [ -d /run/initramfs/squashfs/LiveOS ]; then
         if [ -f /run/initramfs/squashfs/LiveOS/rootfs.img ]; then
             FSIMG="/run/initramfs/squashfs/LiveOS/rootfs.img"
@@ -337,6 +348,7 @@ if [ -e "$SQUASHED" ]; then
         fi
     elif [ -d /run/initramfs/squashfs/proc ]; then
         FSIMG=$SQUASHED
+        FSIMG_JOIN=$SQUASHED_JOIN
         if [ -z "$overlayfs" ] && [ -n "$DRACUT_SYSTEMD" ]; then
             reloadsysrootmountunit=":>/xor_overlayfs;"
         fi
@@ -352,6 +364,9 @@ else
     elif [ -e /run/initramfs/live/${live_dir}/ext3fs.img ]; then
         FSIMG="/run/initramfs/live/${live_dir}/ext3fs.img"
     fi
+    if [ -e /run/initramfs/live/${live_dir}/${join} ]; then
+        FSIMG_JOIN="/run/initramfs/live/${live_dir}/${join}"
+    fi
     if [ -n "$live_ram" ]; then
         echo 'Copying live image to RAM...' > /dev/kmsg
         echo ' (this may take a minute or so)' > /dev/kmsg
@@ -414,6 +429,10 @@ if [ -n "$overlayfs" ]; then
     if [ -n "$FSIMG" ]; then
         mkdir -m 0755 -p /run/rootfsbase
         mount -r $FSIMG /run/rootfsbase
+        if [ -n "${join}" ]; then
+            mkdir -m 0755 /run/rootfsjoin
+            mount -r $FSIMG_JOIN /run/rootfsjoin
+        fi
     else
         ln -sf /run/initramfs/live /run/rootfsbase
     fi
