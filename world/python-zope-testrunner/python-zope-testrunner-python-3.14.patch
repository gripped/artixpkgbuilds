From cc20e2c9034d04c3346daa8f30d0d0be377c58a8 Mon Sep 17 00:00:00 2001
From: Carl Smedstad <carsme@archlinux.org>
Date: Sat, 27 Dec 2025 20:53:26 +0100
Subject: [PATCH] Adapt test for Python 3.14

---
 .../testrunner/tests/testrunner-colors.rst    | 96 ++++++++++---------
 .../tests/testrunner-edge-cases.rst           | 11 +--
 2 files changed, 57 insertions(+), 50 deletions(-)

diff --git a/src/zope/testrunner/tests/testrunner-colors.rst b/src/zope/testrunner/tests/testrunner-colors.rst
index be4b864..8d4df00 100644
--- a/src/zope/testrunner/tests/testrunner-colors.rst
+++ b/src/zope/testrunner/tests/testrunner-colors.rst
@@ -74,80 +74,88 @@ A failed test run highlights the failures in red:
 
     >>> sys.argv = 'test -c --tests-pattern ^sampletests(f|_e|_f)?$ '.split()
     >>> testrunner.run_internal(defaults)
+    ... # doctest: +ELLIPSIS
     {normal}Running zope.testrunner.layer.UnitTests tests:{normal}
       Set up zope.testrunner.layer.UnitTests in {green}N.NNN{normal} seconds.
-    <BLANKLINE>
-    <BLANKLINE>
     {boldred}Failure in test eek (sample2.sampletests_e){normal}
     Failed doctest test for sample2.sampletests_e.eek
-      File "testrunner-ex/sample2/sampletests_e.py", line 28, in eek
-    <BLANKLINE>
-    ...
-    {normal}File "{boldblue}testrunner-ex/sample2/sampletests_e.py{normal}", line {boldred}30{normal}, in {boldcyan}sample2.sampletests_e.eek{normal}
+     testrunner-ex/sample2/sampletests_e.py", Line NNN, in eek
+    ----------------------------------------------------------------------
+    {normal}File testrunner-ex/sample2/sampletests_e.py{normal}", Line {boldred}NNN{normal}, in {boldcyan}sample2.sampletests_e.eek{normal}
     Failed example:
     {cyan}    f(){normal}
     Exception raised:
     {red}    Traceback (most recent call last):{normal}
-    {red}      File ".../doctest.py", line 1356, in __run{normal}
-    {red}        ...{normal}
-    {red}      File "<doctest sample2.sampletests_e.eek[0]>", line 1, in ?{normal}
+    {red}      File "<doctest sample2.sampletests_e.eek[0]>", Line NNN, in ?{normal}
     {red}        f(){normal}
-    {red}      File "testrunner-ex/sample2/sampletests_e.py", line 19, in f{normal}
+    {red} testrunner-ex/sample2/sampletests_e.py", Line NNN, in f{normal}
     {red}        g(){normal}
-    {red}      File "testrunner-ex/sample2/sampletests_e.py", line 24, in g{normal}
+    {red} testrunner-ex/sample2/sampletests_e.py", Line NNN, in g{normal}
     {red}        x = y + 1  # noqa: F821{normal}
     {red}       - __traceback_info__: I don't know what Y should be.{normal}
     {red}    NameError: name 'y' is not defined{normal}
-    <BLANKLINE>
-    <BLANKLINE>
-    <BLANKLINE>
-    {boldred}Error in test test3 (sample2.sampletests_e.Test...){normal}
+    {boldred}Error in test test3 (sample2.sampletests_e.Test.test3){normal}
     Traceback (most recent call last):
-    {normal}  File "{boldblue}unittest.py{normal}", line {boldred}260{normal}, in {boldcyan}run{normal}
-    {cyan}    testMethod(){normal}
-    {normal}  File "{boldblue}testrunner-ex/sample2/sampletests_e.py{normal}", line {boldred}43{normal}, in {boldcyan}test3{normal}
+    {normal} testrunner-ex/sample2/sampletests_e.py{normal}", Line {boldred}NNN{normal}, in {boldcyan}test3{normal}
     {cyan}    f(){normal}
-    {normal}  File "{boldblue}testrunner-ex/sample2/sampletests_e.py{normal}", line {boldred}19{normal}, in {boldcyan}f{normal}
+    {normal} testrunner-ex/sample2/sampletests_e.py{normal}", Line {boldred}NNN{normal}, in {boldcyan}f{normal}
     {cyan}    g(){normal}
-    {normal}  File "{boldblue}testrunner-ex/sample2/sampletests_e.py{normal}", line {boldred}24{normal}, in {boldcyan}g{normal}
+    {normal} testrunner-ex/sample2/sampletests_e.py{normal}", Line {boldred}NNN{normal}, in {boldcyan}g{normal}
     {cyan}    x = y + 1  # noqa: F821{normal}
     {red}   - __traceback_info__: I don't know what Y should be.{normal}
     {red}NameError: name 'y' is not defined{normal}
-    <BLANKLINE>
-    <BLANKLINE>
-    <BLANKLINE>
-    {boldred}Failure in test testrunner-ex/sample2/e.rst{normal}
+    {boldred}Failure testrunner-ex/sample2/e.rst{normal}
     Failed doctest test for e.rst
-      File "testrunner-ex/sample2/e.rst", line 0
-    <BLANKLINE>
-    ...
-    {normal}File "{boldblue}testrunner-ex/sample2/e.rst{normal}", line {boldred}4{normal}, in {boldcyan}e.rst{normal}
+     testrunner-ex/sample2/e.rst", line 0
+    ----------------------------------------------------------------------
+    {normal}File testrunner-ex/sample2/e.rst{normal}", Line {boldred}NNN{normal}, in {boldcyan}e.rst{normal}
     Failed example:
     {cyan}    f(){normal}
     Exception raised:
     {red}    Traceback (most recent call last):{normal}
-    {red}      File ".../doctest.py", line 1356, in __run{normal}
-    {red}        ...{normal}
-    {red}      File "<doctest e.rst[1]>", line 1, in ?{normal}
+    {red}      File "<doctest e.rst[1]>", Line NNN, in ?{normal}
     {red}        f(){normal}
-    {red}      File "<doctest e.rst[0]>", line 2, in f{normal}
+    {red}      File "<doctest e.rst[0]>", Line NNN, in f{normal}
     {red}        return x{normal}
     {red}    NameError: name 'x' is not defined{normal}
-    <BLANKLINE>
-    <BLANKLINE>
-    <BLANKLINE>
-    {boldred}Failure in test test (sample2.sampletests_f.Test...){normal}
+    {boldred}Failure in test test (sample2.sampletests_f.Test.test){normal}
     Traceback (most recent call last):
-    {normal}  File "{boldblue}unittest.py{normal}", line {boldred}260{normal}, in {boldcyan}run{normal}
-    {cyan}    testMethod(){normal}
-    {normal}  File "{boldblue}testrunner-ex/sample2/sampletests_f.py{normal}", line {boldred}21{normal}, in {boldcyan}test{normal}
+    {normal} testrunner-ex/sample2/sampletests_f.py{normal}", Line {boldred}NNN{normal}, in {boldcyan}test{normal}
     {cyan}    self.assertEqual(1, 0){normal}
-    {normal}  File "{boldblue}unittest.py{normal}", line {boldred}333{normal}, in {boldcyan}failUnlessEqual{normal}
-    {cyan}    raise self.failureException, \{normal}
     {red}AssertionError: 1 != 0{normal}
-    <BLANKLINE>
-    {normal}  Ran {green}164{normal} tests with {boldred}3{normal} failures, {boldred}1{normal} errors, {green}0{normal} skipped in {green}0.045{normal} seconds.{normal}
-    ...
+    {normal}  Ran {green}164{normal} tests with {boldred}3{normal} failures, {boldred}1{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer1 tests:{normal}
+      Tear down zope.testrunner.layer.UnitTests in {green}N.NNN{normal} seconds.
+      Set up samplelayers.Layer1 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}9{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer11 tests:{normal}
+      Set up samplelayers.Layer11 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}26{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer111 tests:{normal}
+      Set up samplelayers.Layerx in {green}N.NNN{normal} seconds.
+      Set up samplelayers.Layer111 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}26{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer112 tests:{normal}
+      Tear down samplelayers.Layer111 in {green}N.NNN{normal} seconds.
+      Set up samplelayers.Layer112 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}26{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer12 tests:{normal}
+      Tear down samplelayers.Layer112 in {green}N.NNN{normal} seconds.
+      Tear down samplelayers.Layerx in {green}N.NNN{normal} seconds.
+      Tear down samplelayers.Layer11 in {green}N.NNN{normal} seconds.
+      Set up samplelayers.Layer12 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}26{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer121 tests:{normal}
+      Set up samplelayers.Layer121 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}26{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Running samplelayers.Layer122 tests:{normal}
+      Tear down samplelayers.Layer121 in {green}N.NNN{normal} seconds.
+      Set up samplelayers.Layer122 in {green}N.NNN{normal} seconds.
+    {normal}  Ran {green}26{normal} tests with {green}0{normal} failures, {green}0{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
+    {normal}Tearing down left over layers:{normal}
+      Tear down samplelayers.Layer122 in {green}N.NNN{normal} seconds.
+      Tear down samplelayers.Layer12 in {green}N.NNN{normal} seconds.
+      Tear down samplelayers.Layer1 in {green}N.NNN{normal} seconds.
     {normal}Total: {green}329{normal} tests, {boldred}3{normal} failures, {boldred}1{normal} errors, {green}0{normal} skipped in {green}N.NNN{normal} seconds.{normal}
     True
 
diff --git a/src/zope/testrunner/tests/testrunner-edge-cases.rst b/src/zope/testrunner/tests/testrunner-edge-cases.rst
index c50ee8b..b4da6ea 100644
--- a/src/zope/testrunner/tests/testrunner-edge-cases.rst
+++ b/src/zope/testrunner/tests/testrunner-edge-cases.rst
@@ -91,14 +91,13 @@ Using pdb.set_trace in a function called by an ordinary test:
     >>> try: testrunner.run_internal(defaults)
     ... finally: sys.stdin = real_stdin
     ... # doctest: +ELLIPSIS
-    Running zope.testrunner.layer.UnitTests tests:...
-    > testrunner-ex/sample3/sampletests_d.py(47)f()
-    -> ...
+    Running zope.testrunner.layer.UnitTests tests:
+      Set up zope.testrunner.layer.UnitTests in N.NNN seconds.
     (Pdb) p x
-    1
     (Pdb) c
-      Ran 1 tests with 0 failures, 0 errors and 0 skipped in 0.001 seconds.
-    ...
+      Ran 1 tests with 0 failures, 0 errors and 0 skipped in N.NNN seconds.
+    Tearing down left over layers:
+      Tear down zope.testrunner.layer.UnitTests in N.NNN seconds.
     False
 
 Using pdb.set_trace in a function called by a doctest in a doc string:
-- 
2.52.0

