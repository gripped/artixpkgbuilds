From d3fac5dc6228ede1c6a02c780ffb5b063d86a1ea Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ingo=20Br=C3=BCckl?= <ib@oddnet.de>
Date: Wed, 12 Mar 2025 15:29:30 +0100
Subject: [PATCH] Add a fallback login user interface description for GTK+ 3

Without a greeter-gtk3.ui in the user theme, the screen otherwise
remains blank.

This fixes https://bugs.debian.org/1053089.
---
 data/Makefile.am     |   1 +
 data/lxdm-gtk3.glade | 172 +++++++++++++++++++++++++++++++++++++++++++
 po/POTFILES.in       |   1 +
 src/greeter.c        |   8 +-
 4 files changed, 181 insertions(+), 1 deletion(-)
 create mode 100644 data/lxdm-gtk3.glade

diff --git a/data/Makefile.am b/data/Makefile.am
index ad64b11..3b63989 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -6,6 +6,7 @@ CLEANFILES = $(sbin_SCRIPTS)
 lxdmdir = $(datadir)/lxdm
 lxdm_DATA = \
 	lxdm.glade \
+	lxdm-gtk3.glade \
 	config.ui \
 	$(NULL)
 
diff --git a/data/lxdm-gtk3.glade b/data/lxdm-gtk3.glade
new file mode 100644
index 0000000..7aeb140
--- /dev/null
+++ b/data/lxdm-gtk3.glade
@@ -0,0 +1,172 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<interface>
+  <object class="GtkWindow" id="lxdm">
+    <property name="decorated">False</property>
+    <child>
+      <object class="GtkVBox" id="vbox1">
+        <property name="visible">True</property>
+        <property name="orientation">vertical</property>
+        <child>
+          <object class="GtkAlignment" id="alignment1">
+            <property name="visible">True</property>
+            <property name="xscale">0</property>
+            <property name="yscale">0</property>
+            <child>
+              <object class="GtkHBox" id="hbox3">
+                <property name="visible">True</property>
+                <property name="spacing">12</property>
+                <child>
+                  <object class="GtkLabel" id="prompt">
+                    <property name="visible">True</property>
+                    <property name="label" translatable="yes">User:</property>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="fill">False</property>
+                    <property name="position">0</property>
+                  </packing>
+                </child>
+                <child>
+                  <object class="GtkEntry" id="login_entry">
+                    <property name="visible">True</property>
+                    <property name="can_focus">True</property>
+                    <property name="invisible_char">&#x2022;</property>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="fill">False</property>
+                    <property name="position">1</property>
+                  </packing>
+                </child>
+              </object>
+            </child>
+          </object>
+          <packing>
+            <property name="position">0</property>
+          </packing>
+        </child>
+        <child>
+          <object class="GtkEventBox" id="bottom_pane">
+            <property name="visible">True</property>
+            <child>
+              <object class="GtkHBox" id="bottom_hbox">
+                <property name="visible">True</property>
+                <property name="border_width">6</property>
+                <property name="spacing">12</property>
+                <child>
+                  <object class="GtkHBox" id="sessions_box">
+                    <property name="visible">True</property>
+                    <property name="spacing">6</property>
+                    <child>
+                      <object class="GtkLabel" id="label2">
+                        <property name="visible">True</property>
+                        <property name="label" translatable="yes">Desktop:</property>
+                      </object>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="position">0</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <object class="GtkComboBox" id="sessions">
+                        <property name="visible">True</property>
+                        <property name="entry-text-column">0</property>
+                        <property name="has-entry">True</property>
+                      </object>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="position">0</property>
+                  </packing>
+                </child>
+                <child>
+                  <object class="GtkHBox" id="lang_box">
+                    <property name="visible">True</property>
+                    <property name="spacing">6</property>
+                    <child>
+                      <object class="GtkLabel" id="label_lang">
+                        <property name="visible">True</property>
+                        <property name="label" translatable="yes">Language:</property>
+                      </object>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="position">0</property>
+                      </packing>
+                    </child>
+                    <child>
+                      <object class="GtkComboBox" id="lang">
+                        <property name="visible">True</property>
+                        <property name="entry-text-column">0</property>
+                        <property name="has-entry">True</property>
+                      </object>
+                      <packing>
+                        <property name="expand">False</property>
+                        <property name="position">1</property>
+                      </packing>
+                    </child>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="position">1</property>
+                  </packing>
+                </child>
+                <child>
+                  <object class="GtkLabel" id="label_keyboard">
+                    <property name="label" translatable="yes">Keyboard:</property>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="position">2</property>
+                  </packing>
+                </child>
+                <child>
+                  <object class="GtkComboBox" id="keyboard">
+                  <property name="has-entry">True</property>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="position">3</property>
+                  </packing>
+                </child>
+                <child>
+                  <object class="GtkLabel" id="time">
+                    <property name="visible">True</property>
+                    <property name="single_line_mode">True</property>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="position">4</property>
+                  </packing>
+                </child>
+                <child>
+                  <object class="GtkButton" id="exit">
+                    <property name="label">gtk-quit</property>
+                    <property name="visible">True</property>
+                    <property name="can_focus">True</property>
+                    <property name="receives_default">True</property>
+                    <property name="relief">none</property>
+                    <property name="use_stock">True</property>
+                  </object>
+                  <packing>
+                    <property name="expand">False</property>
+                    <property name="pack_type">end</property>
+                    <property name="position">5</property>
+                  </packing>
+                </child>
+              </object>
+            </child>
+          </object>
+          <packing>
+            <property name="expand">False</property>
+            <property name="position">1</property>
+          </packing>
+        </child>
+      </object>
+    </child>
+  </object>
+</interface>
diff --git a/po/POTFILES.in b/po/POTFILES.in
index c70d12b..04b1052 100644
--- a/po/POTFILES.in
+++ b/po/POTFILES.in
@@ -1,4 +1,5 @@
 [type: gettext/glade]data/lxdm.glade
+[type: gettext/glade]data/lxdm-gtk3.glade
 [type: gettext/glade]data/config.ui
 [type: gettext/glade]data/themes/Industrial/greeter.ui
 data/themes/Industrial/greeter-gtk3.ui
diff --git a/src/greeter.c b/src/greeter.c
index 541197f..b47fb39 100644
--- a/src/greeter.c
+++ b/src/greeter.c
@@ -2,6 +2,7 @@
  *      lxdm-ui.c
  *
  *      Copyright 2009 PCMan <pcman.tw@gmail.com>
+ *      Copyright 2025 Ingo Br√ºckl
  *
  *      This program is free software; you can redistribute it and/or modify
  *      it under the terms of the GNU General Public License as published by
@@ -1193,7 +1194,12 @@ static void create_win()
 	g_free(temp);
 
     builder = gtk_builder_new();
-    gtk_builder_add_from_file(builder, ui_file ? ui_file : LXDM_DATA_DIR "/lxdm.glade", NULL);
+    gtk_builder_add_from_file(builder, ui_file ? ui_file : LXDM_DATA_DIR
+#if GTK_CHECK_VERSION(3,0,0)
+                                                                         "/lxdm-gtk3.glade", NULL);
+#else
+                                                                         "/lxdm.glade", NULL);
+#endif
     win = (GtkWidget*)gtk_builder_get_object(builder, "lxdm");
 #if GTK_CHECK_VERSION(3,0,0)
     gtk_window_set_has_resize_grip(GTK_WINDOW(win),FALSE);
-- 
2.51.0

