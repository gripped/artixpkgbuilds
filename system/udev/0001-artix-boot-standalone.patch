From bbccdbb56bccd70fd9e73d5fce28ec01260eda9e Mon Sep 17 00:00:00 2001
From: artoo <artoo@artixlinux.org>
Date: Thu, 18 Dec 2025 17:03:55 +0100
Subject: [PATCH 1/1] artix boot standalone

---
 meson.build                    |  7 +++++++
 meson_options.txt              |  3 +++
 src/bless-boot/meson.build     | 10 +++++++---
 src/boot/meson.build           | 10 +++++-----
 src/bootctl/meson.build        |  3 +++
 src/kernel-install/meson.build | 16 +++++++++++++++-
 6 files changed, 40 insertions(+), 9 deletions(-)

diff --git a/meson.build b/meson.build
index fd2b335ce5..9c662ddf8c 100644
--- a/meson.build
+++ b/meson.build
@@ -2767,6 +2767,7 @@ ukify = custom_target(
         output : 'ukify',
         command : [jinja2_cmdline, '@INPUT@', '@OUTPUT@'],
         install : want_ukify,
+        install_tag: 'eukify',
         install_mode : 'rwxr-xr-x',
         depends : ukify_depends,
         install_dir : bindir)
@@ -2873,6 +2874,11 @@ install_data('LICENSE.GPL2',
              install_tag : 'esysusers',
              install_dir : datadir / 'doc/esysusers')
 
+install_data('LICENSE.GPL2',
+             'LICENSE.LGPL2.1',
+             install_tag : 'eboot',
+             install_dir : datadir / 'doc/egummiboot')
+
 install_emptydir(systemdstatedir)
 
 #####################################################################
@@ -3247,6 +3253,7 @@ foreach tuple : [
         ['link-journalctl-shared', get_option('link-journalctl-shared')],
         ['link-boot-shared',       get_option('link-boot-shared')],
         ['link-portabled-shared',  get_option('link-portabled-shared')],
+        ['link-kernel-install-shared', get_option('link-kernel-install-shared')],
         ['first-boot-full-preset'],
         ['fexecve'],
         ['standalone-binaries',    get_option('standalone-binaries')],
diff --git a/meson_options.txt b/meson_options.txt
index 4ce3c7faca..c4e6d40ab8 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -563,3 +563,6 @@ option('vmlinux-h-path', type : 'string', value : '',
 
 option('default-mountfsd-trusted-directories', type : 'boolean', value: false,
        description : 'controls whether mountfsd should apply a relaxed policy on DDIs in system DDI directories')
+
+option('link-kernel-install-shared', type: 'boolean',
+       description : 'link kernel-install against libsystemd-shared.so')
diff --git a/src/bless-boot/meson.build b/src/bless-boot/meson.build
index ae814f1b29..9706c0a08d 100644
--- a/src/bless-boot/meson.build
+++ b/src/bless-boot/meson.build
@@ -11,7 +11,7 @@ endif
 
 executables += [
         libexec_template + {
-                'name' : 'systemd-bless-boot',
+                'name' : 'ebless-boot',
                 'public' : true,
                 'conditions' : [
                         'HAVE_BLKID',
@@ -19,18 +19,22 @@ executables += [
                 ],
                 'sources' : files('bless-boot.c'),
                 'link_with' : boot_link_with,
+                'install_tag' : 'ebless',
+                'install_dir' : bindir,
         },
         generator_template + {
-                'name' : 'systemd-bless-boot-generator',
+                'name' : 'ebless-boot-generator',
                 'conditions' : [
                         'HAVE_BLKID',
                         'ENABLE_BOOTLOADER',
                 ],
                 'sources' : files('bless-boot-generator.c'),
                 'link_with' : boot_link_with,
+                'install_tag' : 'ebless',
+                'install_dir' : bindir,
         },
         libexec_template + {
-                'name' : 'systemd-boot-check-no-failures',
+                'name' : 'eboot-check-no-failures',
                 'sources' : files('boot-check-no-failures.c'),
         },
 ]
diff --git a/src/boot/meson.build b/src/boot/meson.build
index 3d1f66a658..bd109cf01f 100644
--- a/src/boot/meson.build
+++ b/src/boot/meson.build
@@ -195,7 +195,7 @@ efi_c_ld_args = [
 
         # These flags should be passed by -static-pie, but for whatever reason the flag translation
         # is not enabled on all architectures. Not passing `-static` would just allow the linker to
-        # use dynamic libraries, (which we can't/don't use anyway). But if `-pie` is missing and the
+        # use dynamic libraries, (which we can't/dsystemd-on't use anyway). But if `-pie` is missing and the
         # gcc build does not default to `-pie` we get a regular (no-pie) binary that will be
         # rightfully rejected by elf2efi. Note that meson also passes `-pie` to the linker driver,
         # but it is overridden by our `-static-pie`. We also need to pass these directly to the
@@ -414,7 +414,7 @@ foreach archspec : efi_archspecs
         }
 
         efi_elf_binaries += executable(
-                'systemd-boot' + archspec['arch'],
+                'eboot' + archspec['arch'],
                 sources : [systemd_boot_sources, version_h],
                 link_with : libefi,
                 name_suffix : 'elf',
@@ -436,7 +436,7 @@ endforeach
 
 foreach efi_elf_binary : efi_elf_binaries
         name = efi_elf_binary.name()
-        name += name.startswith('systemd-boot') ? '.efi' : '.efi.stub'
+        name += name.startswith('eboot') ? '.efi' : '.efi.stub'
 
         # For the addon, given it's empty, we need to explicitly reserve space in the header to account for
         # the sections that ukify will add.
@@ -453,7 +453,7 @@ foreach efi_elf_binary : efi_elf_binaries
                 input : efi_elf_binary,
                 install : true,
                 install_dir : bootlibdir,
-                install_tag : 'systemd-boot',
+                install_tag : 'eboot',
                 command : [
                         elf2efi_py,
                         f'--version-major=@project_major_version@',
@@ -482,4 +482,4 @@ foreach efi_elf_binary : efi_elf_binaries
              suite : 'boot')
 endforeach
 
-alias_target('systemd-boot', boot_targets)
+alias_target('eboot', boot_targets)
diff --git a/src/bootctl/meson.build b/src/bootctl/meson.build
index 7522cd10a9..8de5e7fd28 100644
--- a/src/bootctl/meson.build
+++ b/src/bootctl/meson.build
@@ -21,5 +21,8 @@ executables += [
                 'sources' : bootctl_sources,
                 'link_with' : boot_link_with,
                 'dependencies' : [libopenssl],
+                'install' : true,
+                'install_tag' : 'eboot',
+                'install_dir' : bindir,
         },
 ]
diff --git a/src/kernel-install/meson.build b/src/kernel-install/meson.build
index 716fffb46b..d16fa467d5 100644
--- a/src/kernel-install/meson.build
+++ b/src/kernel-install/meson.build
@@ -2,12 +2,21 @@
 
 want_kernel_install = conf.get('ENABLE_KERNEL_INSTALL') == 1
 
+if get_option('link-kernel-install-shared')
+        kernel_install_link_with = [libshared]
+else
+        kernel_install_link_with = [libsystemd_static, libshared_static]
+endif
+
 executables += [
         executable_template + {
                 'name' : 'kernel-install',
                 'public' : true,
                 'conditions' : ['ENABLE_KERNEL_INSTALL'],
                 'sources' : files('kernel-install.c'),
+                'link_with' : kernel_install_link_with,
+                'install_tag' : 'kernel-install',
+                'install_dir' : bindir
         },
 ]
 
@@ -17,6 +26,7 @@ ukify_install = custom_target(
         command : [jinja2_cmdline, '@INPUT@', '@OUTPUT@'],
         install : want_kernel_install and want_ukify,
         install_mode : 'rwxr-xr-x',
+        install_tag: 'eukify',
         install_dir : kernelinstalldir)
 
 loaderentry_install = custom_target(
@@ -25,6 +35,7 @@ loaderentry_install = custom_target(
         command : [jinja2_cmdline, '@INPUT@', '@OUTPUT@'],
         install : want_kernel_install,
         install_mode : 'rwxr-xr-x',
+        install_tag: 'kernel-install',
         install_dir : kernelinstalldir)
 
 uki_copy_install = files('90-uki-copy.install')
@@ -36,18 +47,21 @@ kernel_install_files = uki_copy_install + files(
 if want_kernel_install
         install_data(kernel_install_files,
                      install_mode : 'rwxr-xr-x',
+                     install_tag: 'kernel-install',
                      install_dir : kernelinstalldir)
 
         install_data('install.conf',
+                install_tag: 'kernel-install',
                      install_dir : kerneldir)
 
         if want_ukify
                 install_data('uki.conf',
+                        install_tag: 'kernel-install',
                              install_dir : kerneldir)
         endif
 
         if install_sysconfdir
-                install_emptydir(sysconfdir / 'kernel/install.d')
+                install_emptydir(sysconfdir / 'kernel/install.d', install_tag: 'kernel-install')
         endif
 endif
 
-- 
2.52.0

