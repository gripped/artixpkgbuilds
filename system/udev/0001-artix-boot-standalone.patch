From 949df9e1b0b30b627e64a83026125ccc997588d9 Mon Sep 17 00:00:00 2001
From: artoo <artoo@artixlinux.org>
Date: Mon, 22 Sep 2025 15:17:59 +0200
Subject: [PATCH 1/1] artix boot standalone

---
 meson.build                    |  7 +++++++
 meson_options.txt              |  3 +++
 src/bless-boot/meson.build     | 10 +++++++---
 src/boot/meson.build           |  8 ++++----
 src/bootctl/meson.build        |  3 +++
 src/kernel-install/meson.build | 16 +++++++++++++++-
 6 files changed, 39 insertions(+), 8 deletions(-)

diff --git a/meson.build b/meson.build
index 2014e1e8ee..1b1350aa2a 100644
--- a/meson.build
+++ b/meson.build
@@ -2701,6 +2701,7 @@ ukify = custom_target(
         install : want_ukify,
         install_mode : 'rwxr-xr-x',
         depends : ukify_depends,
+        install_tag: 'eukify',
         install_dir : bindir)
 if want_ukify
         public_programs += ukify
@@ -2805,6 +2806,11 @@ install_data('LICENSE.GPL2',
              install_tag : 'esysusers',
              install_dir : datadir / 'doc/esysusers')
 
+install_data('LICENSE.GPL2',
+             'LICENSE.LGPL2.1',
+             install_tag : 'eboot',
+             install_dir : datadir / 'doc/egummiboot')
+
 install_emptydir(systemdstatedir)
 
 #####################################################################
@@ -3163,6 +3169,7 @@ foreach tuple : [
         ['link-journalctl-shared', get_option('link-journalctl-shared')],
         ['link-boot-shared',       get_option('link-boot-shared')],
         ['link-portabled-shared',  get_option('link-portabled-shared')],
+        ['link-kernel-install-shared', get_option('link-kernel-install-shared')],
         ['first-boot-full-preset'],
         ['fexecve'],
         ['standalone-binaries',    get_option('standalone-binaries')],
diff --git a/meson_options.txt b/meson_options.txt
index d8dec33ec4..6e3e5fc298 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -552,3 +552,6 @@ option('vmlinux-h-path', type : 'string', value : '',
 
 option('default-mountfsd-trusted-directories', type : 'boolean', value: false,
        description : 'controls whether mountfsd should apply a relaxed policy on DDIs in system DDI directories')
+
+option('link-kernel-install-shared', type: 'boolean',
+       description : 'link kernel-install against libsystemd-shared.so')
diff --git a/src/bless-boot/meson.build b/src/bless-boot/meson.build
index 003f110664..412a879e74 100644
--- a/src/bless-boot/meson.build
+++ b/src/bless-boot/meson.build
@@ -11,7 +11,7 @@ endif
 
 executables += [
         libexec_template + {
-                'name' : 'systemd-bless-boot',
+                'name' : 'ebless-boot',
                 'public' : true,
                 'conditions' : [
                         'HAVE_BLKID',
@@ -20,18 +20,22 @@ executables += [
                 'sources' : files('bless-boot.c'),
                 'link_with' : boot_link_with,
                 'dependencies' : libblkid,
+                'install_tag' : 'ebless',
+                'install_dir' : bindir,
         },
         generator_template + {
-                'name' : 'systemd-bless-boot-generator',
+                'name' : 'ebless-boot-generator',
                 'conditions' : [
                         'HAVE_BLKID',
                         'ENABLE_BOOTLOADER',
                 ],
                 'sources' : files('bless-boot-generator.c'),
                 'link_with' : boot_link_with,
+                'install_tag' : 'ebless',
+                'install_dir' : bindir,
         },
         libexec_template + {
-                'name' : 'systemd-boot-check-no-failures',
+                'name' : 'eboot-check-no-failures',
                 'sources' : files('boot-check-no-failures.c'),
         },
 ]
diff --git a/src/boot/meson.build b/src/boot/meson.build
index ba0b309acf..e12e0ffc9e 100644
--- a/src/boot/meson.build
+++ b/src/boot/meson.build
@@ -406,7 +406,7 @@ foreach archspec : efi_archspecs
         }
 
         efi_elf_binaries += executable(
-                'systemd-boot' + archspec['arch'],
+                'eboot' + archspec['arch'],
                 sources : [systemd_boot_sources, version_h],
                 link_with : libefi,
                 name_suffix : 'elf',
@@ -428,7 +428,7 @@ endforeach
 
 foreach efi_elf_binary : efi_elf_binaries
         name = efi_elf_binary.name()
-        name += name.startswith('systemd-boot') ? '.efi' : '.efi.stub'
+        name += name.startswith('eboot') ? '.efi' : '.efi.stub'
 
         # For the addon, given it's empty, we need to explicitly reserve space in the header to account for
         # the sections that ukify will add.
@@ -445,7 +445,7 @@ foreach efi_elf_binary : efi_elf_binaries
                 input : efi_elf_binary,
                 install : true,
                 install_dir : bootlibdir,
-                install_tag : 'systemd-boot',
+                install_tag : 'eboot',
                 command : [
                         elf2efi_py,
                         '--version-major=' + project_major_version,
@@ -474,4 +474,4 @@ foreach efi_elf_binary : efi_elf_binaries
              suite : 'boot')
 endforeach
 
-alias_target('systemd-boot', boot_targets)
+alias_target('eboot', boot_targets)
diff --git a/src/bootctl/meson.build b/src/bootctl/meson.build
index ae1f32292b..d3c9ced9a8 100644
--- a/src/bootctl/meson.build
+++ b/src/bootctl/meson.build
@@ -21,5 +21,8 @@ executables += [
                 'sources' : bootctl_sources,
                 'link_with' : boot_link_with,
                 'dependencies' : [libblkid, libopenssl],
+                'install' : true,
+                'install_tag' : 'eboot',
+                'install_dir' : bindir,
         },
 ]
diff --git a/src/kernel-install/meson.build b/src/kernel-install/meson.build
index 716fffb46b..91ea52a80c 100644
--- a/src/kernel-install/meson.build
+++ b/src/kernel-install/meson.build
@@ -2,12 +2,21 @@
 
 want_kernel_install = conf.get('ENABLE_KERNEL_INSTALL') == 1
 
+if get_option('link-kernel-install-shared')
+        kernel_install_link_with = [libshared]
+else
+        kernel_install_link_with = [libsystemd_static, libshared_static]
+endif
+
 executables += [
         executable_template + {
                 'name' : 'kernel-install',
                 'public' : true,
                 'conditions' : ['ENABLE_KERNEL_INSTALL'],
+                'link_with' : kernel_install_link_with,
                 'sources' : files('kernel-install.c'),
+                'install_tag' : 'kernel-install',
+                'install_dir' : bindir
         },
 ]
 
@@ -17,6 +26,7 @@ ukify_install = custom_target(
         command : [jinja2_cmdline, '@INPUT@', '@OUTPUT@'],
         install : want_kernel_install and want_ukify,
         install_mode : 'rwxr-xr-x',
+        install_tag: 'eukify',
         install_dir : kernelinstalldir)
 
 loaderentry_install = custom_target(
@@ -25,6 +35,7 @@ loaderentry_install = custom_target(
         command : [jinja2_cmdline, '@INPUT@', '@OUTPUT@'],
         install : want_kernel_install,
         install_mode : 'rwxr-xr-x',
+        install_tag: 'kernel-install',
         install_dir : kernelinstalldir)
 
 uki_copy_install = files('90-uki-copy.install')
@@ -36,18 +47,21 @@ kernel_install_files = uki_copy_install + files(
 if want_kernel_install
         install_data(kernel_install_files,
                      install_mode : 'rwxr-xr-x',
+                     install_tag: 'kernel-install',
                      install_dir : kernelinstalldir)
 
         install_data('install.conf',
+                install_tag: 'kernel-install',
                      install_dir : kerneldir)
 
         if want_ukify
                 install_data('uki.conf',
+                        install_tag: 'kernel-install',
                              install_dir : kerneldir)
         endif
 
         if install_sysconfdir
-                install_emptydir(sysconfdir / 'kernel/install.d')
+                install_emptydir(sysconfdir / 'kernel/install.d', install_tag : 'kernel-install')
         endif
 endif
 
-- 
2.51.0

