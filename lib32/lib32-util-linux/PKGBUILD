# Maintainer: Dave Reisner <dreisner@archlinux.org>
# Contributor: judd <jvinet@zeroflux.org>

_pkgbasename=util-linux
pkgname=lib32-${_pkgbasename}
pkgver=2.41.3
pkgrel=1
pkgdesc='Miscellaneous system utilities for Linux (32-bit)'
url='https://github.com/util-linux/util-linux'
arch=('x86_64')
makedepends=('git' 'meson' 'lib32-libxcrypt' 'lib32-ncurses')
depends=('util-linux-libs' 'lib32-glibc')
provides=('libuuid.so' 'libblkid.so' 'libfdisk.so' 'libmount.so' 'libsmartcols.so')
license=(
  'BSD-2-Clause'
  'BSD-3-Clause'
  'BSD-4-Clause-UC'
  'GPL-2.0-only'
  'GPL-2.0-or-later'
  'GPL-3.0-or-later'
  'ISC'
  'LGPL-2.1-or-later'
  'LicenseRef-PublicDomain'
)
options=('!emptydirs')
validpgpkeys=('B0C64D14301CC6EFAEDF60E4E4B71D5EEC39C284')  # Karel Zak
source=("git+https://github.com/util-linux/util-linux#tag=v${pkgver/rc/-rc}?signed")
sha256sums=('d95e1a90d4a0733372f46c4af4fbb6fe7667d96b800c46a0cc05c5abe699eabe')

_backports=(
  # tests: (swaplabel) don't create test image with truncate(1)
  'ccb00ea5efe064b265104fbd19b36883172d9700'
)

_reverts=(
)

prepare() {
  cd "${_pkgbasename}"

  local _c _l
  for _c in "${_backports[@]}"; do
    if [[ "${_c}" == *..* ]]; then _l='--reverse'; else _l='--max-count=1'; fi
    git log --oneline "${_l}" "${_c}"
    git cherry-pick --mainline 1 --no-commit "${_c}"
  done
  for _c in "${_reverts[@]}"; do
    if [[ "${_c}" == *..* ]]; then _l='--reverse'; else _l='--max-count=1'; fi
    git log --oneline "${_l}" "${_c}"
    git revert --mainline 1 --no-commit "${_c}"
  done

  # do not mark dirty
  sed -i '/dirty=/c dirty=' tools/git-version-gen
}

build() {
  export CC="gcc -m32"
  export CXX="g++ -m32"
  export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

  local _meson_options=(
    --libexecdir /usr/lib32
    --libdir     /usr/lib32

    --auto-features disabled

    -Dbuild-libblkid=enabled
    -Dbuild-libuuid=enabled
    -Dbuild-libmount=enabled
    -Dbuild-libsmartcols=enabled
    -Dbuild-libfdisk=enabled

    -Dncurses=disabled
    -Dncursesw=enabled
  )

  artix-meson "${_pkgbasename}" build "${_meson_options[@]}"

  meson compile -C build
}

check() {
  cd build
  ../util-linux/tests/run.sh --show-diff
}

package() {
  DESTDIR="${pkgdir}" meson install -C build

  rm -rf "${pkgdir}"/usr/{bin,include,share}
}
